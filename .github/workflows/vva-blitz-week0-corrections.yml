name: Week 0 Blitz Correction

on:
  # Allows us to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  call-function:
    runs-on: ubuntu-latest # small, quick-to-start runner

    steps:
      - name: Check out repository (with full history & write access)
        uses: actions/checkout@v3
        with:
          # Fetch everything, not just one commit (needed for pushes)
          fetch-depth: 0
          # Persist the GITHUB_TOKEN into .git/config so that git push works
          persist-credentials: true

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          npm install ethers @evmlord/multicall-sdk@latest tsx

      # --- Switch (or create) the cache branch BEFORE running the script ---
      - name: Configure Git for Actions
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Checkout cache branch (create if missing)
        run: |
          BRANCH="cache/vva-blitz-data"
          git fetch origin $BRANCH || true
          if git show-ref --verify --quiet "refs/heads/$BRANCH"; then
            git checkout "$BRANCH"
          elif git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null 2>&1; then
            git checkout -t "origin/$BRANCH"
          else
            # Create from main the first time
            git fetch origin main
            git checkout -B "$BRANCH" origin/main
          fi

      - name: Calculate Week 0 delta
        run: npx tsx Veritas/computeWeek0Corrections.ts

      # --- Commit the whole patch directory (atomic JSON writes already handled by the script) ---
      - name: Commit patch dir (if changed)
        run: |
          BRANCH="cache/vva-blitz-data"
          git add -A Veritas/patch
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update Veritas/patch [ci skip]"
            git push --set-upstream origin "$BRANCH"
          fi

      - name: Open (or update) Pull Request
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const BRANCH = "cache/vva-blitz-data";
            const TITLE  = "chore: update Veritas/patch [ci skip]";
            const BODY   = "Auto-generated by the Blitz Week 0 Correction workflow.";
            const REVIEWERS = ["EVMlord"]; // optional

            // look for an open PR whose head is this exact branch **in this repo**
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              head:  `${context.repo.owner}:${BRANCH}`,
              state: "open",
            });

            let pr;
            if (prs.length === 0) {
              pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo:  context.repo.repo,
                title: TITLE,
                head:  BRANCH,
                base:  "main",
                body:  BODY,
              });
              console.log("Opened PR:", pr.data.html_url);
            } else {
              pr = { data: prs[0] };
              console.log("PR already open:", pr.data.html_url);
            }

            const author = pr.data.user.login;
            const reviewers = REVIEWERS.filter(u => u && u !== author);
            if (reviewers.length) {
              try {
                await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo:  context.repo.repo,
                  pull_number: pr.data.number,
                  reviewers,
                });
                console.log("Reviewers requested:", reviewers.join(", "));
              } catch (e) {
                if (e.status !== 422) throw e;
                console.log("Reviewers already requested; skipping.");
              }
            }
